<!--pages/detail/detail.wxml-->
<view class="container">
  <swiper class="image-swiper" indicator-dots="true" autoplay="{{editingMemoIndex < 0}}" interval="3000" duration="500" bindchange="onImageSwiperChange">
    <swiper-item wx:for="{{plant.images}}" wx:key="*this">
      <view class="image-container">
        <image src="{{item}}" class="swiper-image" mode="aspectFill" bindtap="previewImage" data-src="{{item}}"></image>
        <!-- V0.3 å›¾ç‰‡ä¿¡æ¯æ˜¾ç¤º -->
        <view class="image-info-overlay">
          <!-- æ—¥æœŸå’Œæ“ä½œæŒ‰é’®åœ¨åŒä¸€è¡Œ -->
          <view class="image-date-row" wx:if="{{plant.imageInfos && plant.imageInfos[index]}}">
            <view class="image-date">
              ğŸ“… {{plant.imageInfos[index].date}}
            </view>
            <!-- å›¾ç‰‡æ“ä½œæŒ‰é’® - ä¸æ—¥æœŸåœ¨åŒä¸€è¡Œ -->
            <view class="image-actions-inline" wx:if="{{plant.images.length > 1 && !readonlyShareView}}">
              <text class="action-btn-inline" bindtap="setCoverImage" data-index="{{index}}">{{i18n.image.setCover}}</text>
              <text class="action-btn-inline delete" bindtap="deleteImage" data-index="{{index}}">{{i18n.image.delete}}</text>
            </view>
          </view>
          <!-- ç¼–è¾‘å¤‡å¿˜æ¨¡å¼å ä½ï¼ˆæç¤ºæ­£åœ¨ç¼–è¾‘ï¼‰ï¼Œå®é™…ç¼–è¾‘åœ¨å…¨å±é¢æ¿ -->
          <view wx:if="{{editingMemoIndex === index && !readonlyShareView}}" class="memo-editing-indicator">
            <text>{{i18n.image.memoEditing || 'æ­£åœ¨ç¼–è¾‘å¤‡å¿˜â€¦'}}</text>
          </view>
          <!-- æ˜¾ç¤ºå¤‡å¿˜æ¨¡å¼ -->
          <view wx:elif="{{plant.imageInfos && plant.imageInfos[index] && plant.imageInfos[index].memo}}" 
                class="image-memo" 
                bindtap="{{readonlyShareView ? '' : 'editImageMemo'}}" 
                data-index="{{index}}">
            {{plant.imageInfos[index].memo}}
          </view>
          <!-- æ·»åŠ å¤‡å¿˜æŒ‰é’® - ä»…åœ¨éåˆ†äº«æ¨¡å¼ä¸‹æ˜¾ç¤º -->
          <view wx:elif="{{plant.imageInfos && plant.imageInfos[index] && !readonlyShareView}}" 
                class="add-memo-btn" 
                bindtap="editImageMemo" 
                data-index="{{index}}">
            {{i18n.image.addMemo}}
          </view>
        </view>
        <!-- V0.3 å›¾ç‰‡é¡ºåºè°ƒæ•´æŒ‰é’® - ä»…åœ¨éåˆ†äº«æ¨¡å¼ä¸‹æ˜¾ç¤º -->
        <view class="image-order-actions" wx:if="{{plant.images.length > 1 && !readonlyShareView}}">
          <text class="order-btn" wx:if="{{index > 0}}" bindtap="moveImageUp" data-index="{{index}}">â¬†ï¸</text>
          <text class="order-btn" wx:if="{{index < plant.images.length - 1}}" bindtap="moveImageDown" data-index="{{index}}">â¬‡ï¸</text>
        </view>
        <view class="cover-badge" wx:if="{{index === 0}}">{{i18n.image.coverBadge}}</view>
      </view>
    </swiper-item>
  </swiper>

  <!-- åˆ†äº«è¯„è®ºå’Œç‚¹èµï¼ˆä»…æ‰€æœ‰è€…å¯è§ï¼‰ -->
  <view class="content-box" wx:if="{{!readonlyShareView}}">
    <view class="section-title">
      <text class="title-icon">ğŸ’¬</text>
      <text>{{i18n.comments.title}}</text>
      <text style="margin-left: 8rpx; color: #888;">â™¡ {{shareLikesCount}}</text>
    </view>
    <view class="comment-list-owner">
      <view class="comment-empty" wx:if="{{!shareCommentsCount}}">{{i18n.comments.none}}</view>
      <block wx:for="{{shareCommentsToShow}}" wx:key="id">
        <view class="comment-item">
          <text class="comment-nick">{{item.nickname}}ï¼š</text>
          <text class="comment-content">{{item.content}}</text>
          <text class="comment-time"> {{item.timeText}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- å…¨å±å¤‡å¿˜ç¼–è¾‘é¢æ¿ï¼ˆæ›´å‹å¥½çš„ç¼–è¾‘ä½“éªŒï¼‰ -->
  <view wx:if="{{editingMemoIndex >= 0 && !readonlyShareView}}" class="memo-editor-modal" catchtouchmove="true">
    <view class="memo-editor-panel" catchtap="stopPropagation">
      <view class="memo-editor-header">
        <text class="memo-editor-title">{{i18n.image.memoTitle || 'ç¼–è¾‘å¤‡å¿˜'}}</text>
        <text class="memo-editor-close" bindtap="cancelMemoEdit">âœ•</text>
      </view>
      <textarea class="memo-editor-input"
                value="{{editingMemo}}"
                bindinput="onMemoInput"
                placeholder="{{i18n.image.memoPlaceholder}}"
                maxlength="500"
                focus="true"
                auto-height="true"
                show-confirm-bar="true"
                adjust-position="false"
                cursor-spacing="40"></textarea>
      <view class="memo-editor-footer">
        <text class="memo-char-count">{{memoCharCount}}/500</text>
        <view class="memo-editor-actions">
          <button class="memo-btn cancel" size="mini" bindtap="cancelMemoEdit">{{i18n.image.memoCancel}}</button>
          <button class="memo-btn save" type="primary" size="mini" bindtap="saveImageMemo">{{i18n.image.memoSave}}</button>
        </view>
      </view>
      <!-- é”®ç›˜é«˜åº¦å ä½ï¼Œé¿å…é®æŒ¡ -->
      <view style="height: {{keyboardHeight}}px;"></view>
    </view>
  </view>

  <view class="content-box">
    <!-- æ•°æ®æ¢å¤æŒ‰é’® - ä»…åœ¨å›¾ç‰‡ä¿¡æ¯ä¸¢å¤±æ—¶æ˜¾ç¤º -->
    <view wx:if="{{!plant.imageInfos || plant.imageInfos.length === 0}}" class="recovery-section">
      <view class="recovery-tip">
        <text class="recovery-icon">âš ï¸</text>
        <text class="recovery-text">å›¾ç‰‡ä¿¡æ¯å¯èƒ½ä¸¢å¤±ï¼Œå°è¯•æ¢å¤æ•°æ®</text>
      </view>
      <button class="recovery-btn" bindtap="recoverImageData">æ¢å¤æ•°æ®</button>
    </view>
    
    
    <!-- è¯†åˆ«åç§° -->
    <view class="plant-title-container">
      <text class="plant-title" wx:if="{{!isEditingName}}">{{plant.aiResult.name || i18nCommon.unknownPlant}}</text>
      <input class="plant-title-edit" wx:if="{{isEditingName && !readonlyShareView}}" value="{{plant.aiResult.name || i18nCommon.unknownPlant}}" bindinput="onNameInput" bindblur="saveName" focus="{{isEditingName}}" />
      <text class="edit-icon" wx:if="{{!readonlyShareView}}" bindtap="toggleNameEdit">{{isEditingName ? 'âœ“' : 'âœï¸'}}</text>
    </view>
    
    <!-- å…»æŠ¤ä¿¡æ¯ -->
    <view class="info-section">
      <view class="info-card">
        <text class="info-icon">ğŸ“…</text>
        <view class="info-text">
          <view class="info-label">{{i18n.info.recordedAt}}</view>
          <view class="info-value">{{plant.createDate}}</view>
        </view>
      </view>
      <view class="info-card" bindtap="viewWateringHistory">
        <text class="info-icon">ğŸ’§</text>
        <view class="info-text">
          <view class="info-label">{{i18n.history.titleWatering}}</view>
          <view class="info-value">{{plant.wateringHistory && plant.wateringHistory.length > 0 ? plant.wateringHistory.length + i18n.history.recordUnit : i18n.history.none}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.wateringHistory && plant.wateringHistory.length > 0}}">{{i18n.history.viewDetails}}</text>
      </view>
      <view class="info-card" bindtap="viewFertilizingHistory">
        <text class="info-icon">ğŸŒ±</text>
        <view class="info-text">
          <view class="info-label">{{i18n.history.titleFertilizing}}</view>
          <view class="info-value">{{plant.fertilizingHistory && plant.fertilizingHistory.length > 0 ? plant.fertilizingHistory.length + i18n.history.recordUnit : i18n.history.none}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.fertilizingHistory && plant.fertilizingHistory.length > 0}}">{{i18n.history.viewDetails}}</text>
      </view>
      
      <!-- æ“ä½œæŒ‰é’® - ä»…åœ¨éåˆ†äº«æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼Œç§»åˆ°æ–½è‚¥è®°å½•åé¢ -->
      <view class="action-buttons" wx:if="{{!readonlyShareView}}">
        <button class="action-btn" bindtap="updateWatering">{{i18n.history.updateWatering}}</button>
        <button class="action-btn" bindtap="updateFertilizing">{{i18n.history.updateFertilizing}}</button>
        <button class="action-btn" bindtap="takePhoto">{{i18n.history.takePhoto}}</button>
      </view>
      <view class="info-card" bindtap="viewHealthAnalyses" wx:if="{{selectedModel === 'qwen-vl'}}">
        <text class="info-icon">ğŸ¥</text>
        <view class="info-text">
          <view class="info-label">{{i18n.info.healthAnalysis}}</view>
          <view class="info-value">{{plant.healthAnalyses && plant.healthAnalyses.length > 0 ? plant.healthAnalyses.length + i18n.history.analysisUnit : i18n.info.noAnalysis}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.healthAnalyses && plant.healthAnalyses.length > 0}}">{{i18n.history.viewDetails}}</text>
      </view>
    </view>

    <!-- AI ç™¾ç§‘ä¿¡æ¯ -->
    <view class="baike-section" wx:if="{{plant.aiResult.baike.description}}">
      <view class="section-title">
        <text class="title-icon">ğŸ“š</text>
        <text>{{i18n.baike.title}}</text>
      </view>
      <view class="baike-description">{{plant.aiResult.baike.description}}</view>
      <view wx:if="{{plant.aiResult.baike.baike_url}}" class="baike-link" bindtap="goToBaike">{{i18n.baike.viewMore}}</view>
    </view>

    <!-- é€šä¹‰åƒé—®VLçš„è¯¦ç»†ç»“æœ -->
    <view class="qwen-detail-section" wx:if="{{plant.aiResult.model === 'qwen-vl'}}">
      <view class="section-title">
        <text class="title-icon">ğŸ¤–</text>
        <text>{{i18n.qwen.sectionTitle}}</text>
      </view>
      
      <!-- æ¤ç‰©å­¦å -->
      <view class="qwen-field" wx:if="{{plant.aiResult.scientificName}}">
        <view class="qwen-field-title">{{i18n.qwen.scientificName}}</view>
        <view class="qwen-field-content">{{plant.aiResult.scientificName}}</view>
      </view>
      
      <!-- æµ‡æ°´tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.wateringTips}}">
        <view class="qwen-field-title">{{i18n.qwen.watering}}</view>
        <view class="qwen-field-content">{{plant.aiResult.wateringTips}}</view>
      </view>
      
      <!-- å…‰ç…§tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.lightingTips}}">
        <view class="qwen-field-title">{{i18n.qwen.lighting}}</view>
        <view class="qwen-field-content">{{plant.aiResult.lightingTips}}</view>
      </view>
      
      <!-- å¥åº·ä¿¡æ¯ -->
      <view class="qwen-field" wx:if="{{plant.aiResult.healthInfo}}">
        <view class="qwen-field-title">{{i18n.qwen.health}}</view>
        <view class="qwen-field-content">{{plant.aiResult.healthInfo}}</view>
      </view>
      
      <!-- ç»¼åˆå…»æŠ¤tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.careTips}}">
        <view class="qwen-field-title">{{i18n.qwen.care}}</view>
        <view class="qwen-field-content">{{plant.aiResult.careTips}}</view>
      </view>
      
      <!-- å°çŸ¥è¯† -->
      <view class="qwen-field" wx:if="{{plant.aiResult.funFacts}}">
        <view class="qwen-field-title">{{i18n.qwen.knowledge}}</view>
        <view class="qwen-field-content">{{plant.aiResult.funFacts}}</view>
      </view>
    </view>

    <!-- ç™¾åº¦AIçš„å…»æŠ¤è¦ç‚¹ -->
    <view class="care-tips-section" wx:if="{{plant.aiResult.careTips && plant.aiResult.model !== 'qwen-vl'}}">
      <view class="section-title">
        <text class="title-icon">ğŸ’¡</text>
        <text>{{i18n.care.sectionTitle}}</text>
      </view>
      <view class="care-tips">
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.watering}}">
          <text class="tip-icon">ğŸ’§</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.watering}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.watering}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.lighting}}">
          <text class="tip-icon">â˜€ï¸</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.lighting}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.lighting}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.temperature}}">
          <text class="tip-icon">ğŸŒ¡ï¸</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.temperature}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.temperature}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.humidity}}">
          <text class="tip-icon">ğŸ’¨</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.humidity}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.humidity}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.fertilizing}}">
          <text class="tip-icon">ğŸŒ±</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.fertilizing}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.fertilizing}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ é™¤æŒ‰é’® - ä»…åœ¨éåˆ†äº«æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼Œæ”¾åœ¨é¡µé¢æœ€ä¸‹æ–¹ -->
  <view class="delete-section" wx:if="{{!readonlyShareView}}">
    <button class="delete-plant-btn" bindtap="deletePlant">ğŸ—‘ï¸ {{i18n.buttons.deletePlant}}</button>
  </view>

  <!-- å†å²è®°å½•å¼¹çª— -->
  <view class="history-modal" wx:if="{{showHistoryModal}}" bindtap="closeHistoryModal">
    <view class="history-content" catchtap="stopPropagation">
      <view class="history-header">
        <text class="history-title">{{historyModalTitle}}</text>
        <text class="close-btn" bindtap="closeHistoryModal">âœ•</text>
      </view>
      <scroll-view class="history-list" scroll-y="true">
        <view class="history-item" wx:for="{{historyModalData}}" wx:key="timestamp">
          <view class="history-date">{{item.formattedDate}} {{item.formattedTime}}</view>
          <view class="history-content" wx:if="{{item.healthAnalysis}}">
            <text class="health-analysis">{{item.healthAnalysis}}</text>
          </view>
        </view>
        <view class="history-empty" wx:if="{{historyModalData.length === 0}}">
          <text class="empty-icon">{{historyModalIcon}}</text>
          <text class="empty-text">{{i18n.history.none}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- éšè—çš„canvasç”¨äºç”Ÿæˆåˆ†äº«å›¾ç‰‡ -->
  <canvas canvas-id="shareCanvas" style="width:300px;height:300px;"></canvas>
  
</view>
