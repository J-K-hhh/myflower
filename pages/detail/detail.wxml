<!--pages/detail/detail.wxml-->
<view class="container">
  <swiper class="image-swiper" indicator-dots="true" autoplay="{{editingMemoIndex < 0}}" interval="3000" duration="500">
    <swiper-item wx:for="{{plant.images}}" wx:key="*this">
      <view class="image-container">
        <image src="{{item}}" class="swiper-image" mode="aspectFill" bindtap="previewImage" data-src="{{item}}"></image>
        <!-- V0.3 图片信息显示 -->
        <view class="image-info-overlay">
          <!-- 日期和操作按钮在同一行 -->
          <view class="image-date-row" wx:if="{{plant.imageInfos && plant.imageInfos[index]}}">
            <view class="image-date">
              📅 {{plant.imageInfos[index].date}}
            </view>
            <!-- 图片操作按钮 - 与日期在同一行 -->
            <view class="image-actions-inline" wx:if="{{plant.images.length > 1 && !readonlyShareView}}">
              <text class="action-btn-inline" bindtap="setCoverImage" data-index="{{index}}">{{i18n.image.setCover}}</text>
              <text class="action-btn-inline delete" bindtap="deleteImage" data-index="{{index}}">{{i18n.image.delete}}</text>
            </view>
          </view>
          <!-- 编辑备忘模式 - 仅在非分享模式下显示 -->
          <view wx:if="{{editingMemoIndex === index && !readonlyShareView}}" class="memo-edit-container">
            <textarea class="memo-edit-input" 
                      value="{{editingMemo}}" 
                      bindinput="onMemoInput" 
                      placeholder="{{i18n.image.memoPlaceholder}}"
                      maxlength="100"
                      auto-height="true"></textarea>
            <view class="memo-edit-actions">
              <text class="memo-btn save" bindtap="saveImageMemo">{{i18n.image.memoSave}}</text>
              <text class="memo-btn cancel" bindtap="cancelMemoEdit">{{i18n.image.memoCancel}}</text>
            </view>
          </view>
          <!-- 显示备忘模式 -->
          <view wx:elif="{{plant.imageInfos && plant.imageInfos[index] && plant.imageInfos[index].memo}}" 
                class="image-memo" 
                bindtap="{{readonlyShareView ? '' : 'editImageMemo'}}" 
                data-index="{{index}}">
            {{plant.imageInfos[index].memo}}
          </view>
          <!-- 添加备忘按钮 - 仅在非分享模式下显示 -->
          <view wx:elif="{{plant.imageInfos && plant.imageInfos[index] && !readonlyShareView}}" 
                class="add-memo-btn" 
                bindtap="editImageMemo" 
                data-index="{{index}}">
            {{i18n.image.addMemo}}
          </view>
        </view>
        <!-- V0.3 图片顺序调整按钮 - 仅在非分享模式下显示 -->
        <view class="image-order-actions" wx:if="{{plant.images.length > 1 && !readonlyShareView}}">
          <text class="order-btn" wx:if="{{index > 0}}" bindtap="moveImageUp" data-index="{{index}}">⬆️</text>
          <text class="order-btn" wx:if="{{index < plant.images.length - 1}}" bindtap="moveImageDown" data-index="{{index}}">⬇️</text>
        </view>
        <view class="cover-badge" wx:if="{{index === 0}}">{{i18n.image.coverBadge}}</view>
      </view>
    </swiper-item>
  </swiper>

  <view class="content-box">
    <!-- 数据恢复按钮 - 仅在图片信息丢失时显示 -->
    <view wx:if="{{!plant.imageInfos || plant.imageInfos.length === 0}}" class="recovery-section">
      <view class="recovery-tip">
        <text class="recovery-icon">⚠️</text>
        <text class="recovery-text">图片信息可能丢失，尝试恢复数据</text>
      </view>
      <button class="recovery-btn" bindtap="recoverImageData">恢复数据</button>
    </view>
    
    
    <!-- 识别名称 -->
    <view class="plant-title-container">
      <text class="plant-title" wx:if="{{!isEditingName}}">{{plant.aiResult.name || i18nCommon.unknownPlant}}</text>
      <input class="plant-title-edit" wx:if="{{isEditingName && !readonlyShareView}}" value="{{plant.aiResult.name || i18nCommon.unknownPlant}}" bindinput="onNameInput" bindblur="saveName" focus="{{isEditingName}}" />
      <text class="edit-icon" wx:if="{{!readonlyShareView}}" bindtap="toggleNameEdit">{{isEditingName ? '✓' : '✏️'}}</text>
    </view>
    
    <!-- 养护信息 -->
    <view class="info-section">
      <view class="info-card">
        <text class="info-icon">📅</text>
        <view class="info-text">
          <view class="info-label">{{i18n.info.recordedAt}}</view>
          <view class="info-value">{{plant.createDate}}</view>
        </view>
      </view>
      <view class="info-card" bindtap="viewWateringHistory">
        <text class="info-icon">💧</text>
        <view class="info-text">
          <view class="info-label">{{i18n.history.titleWatering}}</view>
          <view class="info-value">{{plant.wateringHistory && plant.wateringHistory.length > 0 ? plant.wateringHistory.length + i18n.history.recordUnit : i18n.history.none}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.wateringHistory && plant.wateringHistory.length > 0}}">{{i18n.history.viewDetails}}</text>
      </view>
      <view class="info-card" bindtap="viewFertilizingHistory">
        <text class="info-icon">🌱</text>
        <view class="info-text">
          <view class="info-label">{{i18n.history.titleFertilizing}}</view>
          <view class="info-value">{{plant.fertilizingHistory && plant.fertilizingHistory.length > 0 ? plant.fertilizingHistory.length + i18n.history.recordUnit : i18n.history.none}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.fertilizingHistory && plant.fertilizingHistory.length > 0}}">{{i18n.history.viewDetails}}</text>
      </view>
      
      <!-- 操作按钮 - 仅在非分享模式下显示，移到施肥记录后面 -->
      <view class="action-buttons" wx:if="{{!readonlyShareView}}">
        <button class="action-btn" bindtap="updateWatering">{{i18n.history.updateWatering}}</button>
        <button class="action-btn" bindtap="updateFertilizing">{{i18n.history.updateFertilizing}}</button>
        <button class="action-btn" bindtap="takePhoto">{{i18n.history.takePhoto}}</button>
      </view>
      <view class="info-card" bindtap="viewHealthAnalyses" wx:if="{{selectedModel === 'qwen-vl'}}">
        <text class="info-icon">🏥</text>
        <view class="info-text">
          <view class="info-label">{{i18n.info.healthAnalysis}}</view>
          <view class="info-value">{{plant.healthAnalyses && plant.healthAnalyses.length > 0 ? plant.healthAnalyses.length + i18n.history.analysisUnit : i18n.info.noAnalysis}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.healthAnalyses && plant.healthAnalyses.length > 0}}">{{i18n.history.viewDetails}}</text>
      </view>
    </view>

    <!-- AI 百科信息 -->
    <view class="baike-section" wx:if="{{plant.aiResult.baike.description}}">
      <view class="section-title">
        <text class="title-icon">📚</text>
        <text>{{i18n.baike.title}}</text>
      </view>
      <view class="baike-description">{{plant.aiResult.baike.description}}</view>
      <view wx:if="{{plant.aiResult.baike.baike_url}}" class="baike-link" bindtap="goToBaike">{{i18n.baike.viewMore}}</view>
    </view>

    <!-- 通义千问VL的详细结果 -->
    <view class="qwen-detail-section" wx:if="{{plant.aiResult.model === 'qwen-vl'}}">
      <view class="section-title">
        <text class="title-icon">🤖</text>
        <text>{{i18n.qwen.sectionTitle}}</text>
      </view>
      
      <!-- 植物学名 -->
      <view class="qwen-field" wx:if="{{plant.aiResult.scientificName}}">
        <view class="qwen-field-title">{{i18n.qwen.scientificName}}</view>
        <view class="qwen-field-content">{{plant.aiResult.scientificName}}</view>
      </view>
      
      <!-- 浇水tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.wateringTips}}">
        <view class="qwen-field-title">{{i18n.qwen.watering}}</view>
        <view class="qwen-field-content">{{plant.aiResult.wateringTips}}</view>
      </view>
      
      <!-- 光照tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.lightingTips}}">
        <view class="qwen-field-title">{{i18n.qwen.lighting}}</view>
        <view class="qwen-field-content">{{plant.aiResult.lightingTips}}</view>
      </view>
      
      <!-- 健康信息 -->
      <view class="qwen-field" wx:if="{{plant.aiResult.healthInfo}}">
        <view class="qwen-field-title">{{i18n.qwen.health}}</view>
        <view class="qwen-field-content">{{plant.aiResult.healthInfo}}</view>
      </view>
      
      <!-- 综合养护tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.careTips}}">
        <view class="qwen-field-title">{{i18n.qwen.care}}</view>
        <view class="qwen-field-content">{{plant.aiResult.careTips}}</view>
      </view>
      
      <!-- 小知识 -->
      <view class="qwen-field" wx:if="{{plant.aiResult.funFacts}}">
        <view class="qwen-field-title">{{i18n.qwen.knowledge}}</view>
        <view class="qwen-field-content">{{plant.aiResult.funFacts}}</view>
      </view>
    </view>

    <!-- 百度AI的养护要点 -->
    <view class="care-tips-section" wx:if="{{plant.aiResult.careTips && plant.aiResult.model !== 'qwen-vl'}}">
      <view class="section-title">
        <text class="title-icon">💡</text>
        <text>{{i18n.care.sectionTitle}}</text>
      </view>
      <view class="care-tips">
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.watering}}">
          <text class="tip-icon">💧</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.watering}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.watering}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.lighting}}">
          <text class="tip-icon">☀️</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.lighting}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.lighting}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.temperature}}">
          <text class="tip-icon">🌡️</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.temperature}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.temperature}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.humidity}}">
          <text class="tip-icon">💨</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.humidity}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.humidity}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.fertilizing}}">
          <text class="tip-icon">🌱</text>
          <view class="tip-content">
            <text class="tip-label">{{i18n.care.fertilizing}}</text>
            <text class="tip-text">{{plant.aiResult.careTips.fertilizing}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 删除按钮 - 仅在非分享模式下显示，放在页面最下方 -->
  <view class="delete-section" wx:if="{{!readonlyShareView}}">
    <button class="delete-plant-btn" bindtap="deletePlant">🗑️ {{i18n.buttons.deletePlant}}</button>
  </view>

  <!-- 历史记录弹窗 -->
  <view class="history-modal" wx:if="{{showHistoryModal}}" bindtap="closeHistoryModal">
    <view class="history-content" catchtap="stopPropagation">
      <view class="history-header">
        <text class="history-title">{{historyModalTitle}}</text>
        <text class="close-btn" bindtap="closeHistoryModal">✕</text>
      </view>
      <scroll-view class="history-list" scroll-y="true">
        <view class="history-item" wx:for="{{historyModalData}}" wx:key="timestamp">
          <view class="history-date">{{item.formattedDate}} {{item.formattedTime}}</view>
          <view class="history-content" wx:if="{{item.healthAnalysis}}">
            <text class="health-analysis">{{item.healthAnalysis}}</text>
          </view>
        </view>
        <view class="history-empty" wx:if="{{historyModalData.length === 0}}">
          <text class="empty-icon">{{historyModalIcon}}</text>
          <text class="empty-text">{{i18n.history.none}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 隐藏的canvas用于生成分享图片 -->
  <canvas canvas-id="shareCanvas" style="width:300px;height:300px;"></canvas>
  
</view>
