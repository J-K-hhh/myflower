<!--pages/detail/detail.wxml-->
<view class="container">
  <swiper class="image-swiper" indicator-dots="true" autoplay="true" interval="3000" duration="500">
    <swiper-item wx:for="{{plant.images}}" wx:key="*this">
      <view class="image-container">
        <image src="{{item}}" class="swiper-image" mode="aspectFill" bindtap="previewImage" data-src="{{item}}"></image>
        <!-- V0.3 å›¾ç‰‡ä¿¡æ¯æ˜¾ç¤º -->
        <view class="image-info-overlay">
          <view class="image-date" wx:if="{{plant.imageInfos && plant.imageInfos[index]}}">
            ğŸ“… {{plant.imageInfos[index].date}}
          </view>
          <!-- ç¼–è¾‘å¤‡å¿˜æ¨¡å¼ -->
          <view wx:if="{{editingMemoIndex === index}}" class="memo-edit-container">
            <textarea class="memo-edit-input" 
                      value="{{editingMemo}}" 
                      bindinput="onMemoInput" 
                      placeholder="æ·»åŠ å¤‡å¿˜ä¿¡æ¯..."
                      maxlength="100"
                      auto-height="true"></textarea>
            <view class="memo-edit-actions">
              <text class="memo-btn save" bindtap="saveImageMemo">ä¿å­˜</text>
              <text class="memo-btn cancel" bindtap="cancelMemoEdit">å–æ¶ˆ</text>
            </view>
          </view>
          <!-- æ˜¾ç¤ºå¤‡å¿˜æ¨¡å¼ -->
          <view wx:elif="{{plant.imageInfos && plant.imageInfos[index] && plant.imageInfos[index].memo}}" 
                class="image-memo" 
                bindtap="editImageMemo" 
                data-index="{{index}}">
            ğŸ“ {{plant.imageInfos[index].memo}}
          </view>
          <!-- æ·»åŠ å¤‡å¿˜æŒ‰é’® -->
          <view wx:elif="{{plant.imageInfos && plant.imageInfos[index]}}" 
                class="add-memo-btn" 
                bindtap="editImageMemo" 
                data-index="{{index}}">
            ğŸ“ æ·»åŠ å¤‡å¿˜
          </view>
        </view>
        <view class="image-actions" wx:if="{{plant.images.length > 1}}">
          <text class="action-btn" bindtap="setCoverImage" data-index="{{index}}">è®¾ä¸ºé¢˜å›¾</text>
          <text class="action-btn delete" bindtap="deleteImage" data-index="{{index}}">åˆ é™¤</text>
        </view>
        <!-- V0.3 å›¾ç‰‡é¡ºåºè°ƒæ•´æŒ‰é’® -->
        <view class="image-order-actions" wx:if="{{plant.images.length > 1}}">
          <text class="order-btn" wx:if="{{index > 0}}" bindtap="moveImageUp" data-index="{{index}}">â¬†ï¸</text>
          <text class="order-btn" wx:if="{{index < plant.images.length - 1}}" bindtap="moveImageDown" data-index="{{index}}">â¬‡ï¸</text>
        </view>
        <view class="cover-badge" wx:if="{{index === 0}}">é¢˜å›¾</view>
      </view>
    </swiper-item>
  </swiper>

  <view class="content-box">
    <!-- è¯†åˆ«åç§° -->
    <view class="plant-title-container">
      <text class="plant-title" wx:if="{{!isEditingName}}">{{plant.aiResult.name || 'æœªçŸ¥æ¤ç‰©'}}</text>
      <input class="plant-title-edit" wx:if="{{isEditingName}}" value="{{plant.aiResult.name || 'æœªçŸ¥æ¤ç‰©'}}" bindinput="onNameInput" bindblur="saveName" focus="{{isEditingName}}" />
      <text class="edit-icon" bindtap="toggleNameEdit">{{isEditingName ? 'âœ“' : 'âœï¸'}}</text>
    </view>
    
    <!-- å…»æŠ¤ä¿¡æ¯ -->
    <view class="info-section">
      <view class="info-card">
        <text class="info-icon">ğŸ“…</text>
        <view class="info-text">
          <view class="info-label">è®°å½•æ—¶é—´</view>
          <view class="info-value">{{plant.createDate}}</view>
        </view>
      </view>
      <view class="info-card" bindtap="viewWateringHistory">
        <text class="info-icon">ğŸ’§</text>
        <view class="info-text">
          <view class="info-label">æµ‡æ°´è®°å½•</view>
          <view class="info-value">{{plant.wateringHistory && plant.wateringHistory.length > 0 ? plant.wateringHistory.length + 'æ¬¡è®°å½•' : 'æš‚æ— è®°å½•'}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.wateringHistory && plant.wateringHistory.length > 0}}">æŸ¥çœ‹è¯¦æƒ…</text>
      </view>
      <view class="info-card" bindtap="viewFertilizingHistory">
        <text class="info-icon">ğŸŒ±</text>
        <view class="info-text">
          <view class="info-label">æ–½è‚¥è®°å½•</view>
          <view class="info-value">{{plant.fertilizingHistory && plant.fertilizingHistory.length > 0 ? plant.fertilizingHistory.length + 'æ¬¡è®°å½•' : 'æš‚æ— è®°å½•'}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.fertilizingHistory && plant.fertilizingHistory.length > 0}}">æŸ¥çœ‹è¯¦æƒ…</text>
      </view>
      <view class="info-card" bindtap="viewHealthAnalyses" wx:if="{{selectedModel === 'qwen-vl'}}">
        <text class="info-icon">ğŸ¥</text>
        <view class="info-text">
          <view class="info-label">å¥åº·åˆ†æ</view>
          <view class="info-value">{{plant.healthAnalyses && plant.healthAnalyses.length > 0 ? plant.healthAnalyses.length + 'æ¬¡åˆ†æ' : 'æš‚æ— åˆ†æ'}}</view>
        </view>
        <text class="history-btn" wx:if="{{plant.healthAnalyses && plant.healthAnalyses.length > 0}}">æŸ¥çœ‹è¯¦æƒ…</text>
      </view>
    </view>

    <!-- AI ç™¾ç§‘ä¿¡æ¯ -->
    <view class="baike-section" wx:if="{{plant.aiResult.baike.description}}">
      <view class="section-title">
        <text class="title-icon">ğŸ“š</text>
        <text>å…»æŠ¤å°ç™¾ç§‘</text>
      </view>
      <view class="baike-description">{{plant.aiResult.baike.description}}</view>
      <view wx:if="{{plant.aiResult.baike.baike_url}}" class="baike-link" bindtap="goToBaike">æŸ¥çœ‹æ›´å¤šä¿¡æ¯</view>
    </view>

    <!-- é€šä¹‰åƒé—®VLçš„è¯¦ç»†ç»“æœ -->
    <view class="qwen-detail-section" wx:if="{{plant.aiResult.model === 'qwen-vl'}}">
      <view class="section-title">
        <text class="title-icon">ğŸ¤–</text>
        <text>AIæ™ºèƒ½åˆ†æ</text>
      </view>
      
      <!-- æ¤ç‰©å­¦å -->
      <view class="qwen-field" wx:if="{{plant.aiResult.scientificName}}">
        <view class="qwen-field-title">ğŸŒ¿ å­¦å</view>
        <view class="qwen-field-content">{{plant.aiResult.scientificName}}</view>
      </view>
      
      <!-- æµ‡æ°´tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.wateringTips}}">
        <view class="qwen-field-title">ğŸ’§ æµ‡æ°´tips</view>
        <view class="qwen-field-content">{{plant.aiResult.wateringTips}}</view>
      </view>
      
      <!-- å…‰ç…§tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.lightingTips}}">
        <view class="qwen-field-title">â˜€ï¸ å…‰ç…§tips</view>
        <view class="qwen-field-content">{{plant.aiResult.lightingTips}}</view>
      </view>
      
      <!-- å¥åº·ä¿¡æ¯ -->
      <view class="qwen-field" wx:if="{{plant.aiResult.healthInfo}}">
        <view class="qwen-field-title">ğŸ¥ å¥åº·ä¿¡æ¯</view>
        <view class="qwen-field-content">{{plant.aiResult.healthInfo}}</view>
      </view>
      
      <!-- ç»¼åˆå…»æŠ¤tips -->
      <view class="qwen-field" wx:if="{{plant.aiResult.careTips}}">
        <view class="qwen-field-title">ğŸŒ± ç»¼åˆå…»æŠ¤tips</view>
        <view class="qwen-field-content">{{plant.aiResult.careTips}}</view>
      </view>
      
      <!-- å°çŸ¥è¯† -->
      <view class="qwen-field" wx:if="{{plant.aiResult.funFacts}}">
        <view class="qwen-field-title">ğŸ’¡ å°çŸ¥è¯†</view>
        <view class="qwen-field-content">{{plant.aiResult.funFacts}}</view>
      </view>
    </view>

    <!-- ç™¾åº¦AIçš„å…»æŠ¤è¦ç‚¹ -->
    <view class="care-tips-section" wx:if="{{plant.aiResult.careTips && plant.aiResult.model !== 'qwen-vl'}}">
      <view class="section-title">
        <text class="title-icon">ğŸ’¡</text>
        <text>å…»æŠ¤è¦ç‚¹</text>
      </view>
      <view class="care-tips">
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.watering}}">
          <text class="tip-icon">ğŸ’§</text>
          <view class="tip-content">
            <text class="tip-label">æµ‡æ°´</text>
            <text class="tip-text">{{plant.aiResult.careTips.watering}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.lighting}}">
          <text class="tip-icon">â˜€ï¸</text>
          <view class="tip-content">
            <text class="tip-label">å…‰ç…§</text>
            <text class="tip-text">{{plant.aiResult.careTips.lighting}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.temperature}}">
          <text class="tip-icon">ğŸŒ¡ï¸</text>
          <view class="tip-content">
            <text class="tip-label">æ¸©åº¦</text>
            <text class="tip-text">{{plant.aiResult.careTips.temperature}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.humidity}}">
          <text class="tip-icon">ğŸ’¨</text>
          <view class="tip-content">
            <text class="tip-label">æ¹¿åº¦</text>
            <text class="tip-text">{{plant.aiResult.careTips.humidity}}</text>
          </view>
        </view>
        <view class="tip-item" wx:if="{{plant.aiResult.careTips.fertilizing}}">
          <text class="tip-icon">ğŸŒ±</text>
          <view class="tip-content">
            <text class="tip-label">æ–½è‚¥</text>
            <text class="tip-text">{{plant.aiResult.careTips.fertilizing}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="footer-actions">
    <button class="action-button" bindtap="updateWatering">ğŸ’§ æ›´æ–°æµ‡æ°´</button>
    <button class="action-button" bindtap="updateFertilizing">ğŸŒ± æ›´æ–°æ–½è‚¥</button>
    <button class="action-button" bindtap="takePhoto">ğŸ“· ä¸ºå®ƒæ‹ç…§</button>
    <button class="action-button-danger" bindtap="deletePlant">ğŸ—‘ï¸ åˆ é™¤ç»¿æ¤</button>
  </view>

  <!-- å†å²è®°å½•å¼¹çª— -->
  <view class="history-modal" wx:if="{{showHistoryModal}}" bindtap="closeHistoryModal">
    <view class="history-content" catchtap="stopPropagation">
      <view class="history-header">
        <text class="history-title">{{historyModalTitle}}</text>
        <text class="close-btn" bindtap="closeHistoryModal">âœ•</text>
      </view>
      <scroll-view class="history-list" scroll-y="true">
        <view class="history-item" wx:for="{{historyModalData}}" wx:key="timestamp">
          <view class="history-date">{{item.formattedDate}} {{item.formattedTime}}</view>
          <view class="history-content" wx:if="{{item.healthAnalysis}}">
            <text class="health-analysis">{{item.healthAnalysis}}</text>
          </view>
        </view>
        <view class="history-empty" wx:if="{{historyModalData.length === 0}}">
          <text class="empty-icon">{{historyModalIcon}}</text>
          <text class="empty-text">æš‚æ— è®°å½•</text>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
