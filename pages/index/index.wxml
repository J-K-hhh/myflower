<!--pages/index/index.wxml-->
<view class="container">
  <!-- èƒŒæ™¯å›¾ç‰‡ -->
  <image class="bg-image" src="/images/index-bg.png" mode="aspectFill"></image>
  
  <!-- å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
  <view wx:if="{{plantList.length === 0}}" class="empty-container">
    <view class="empty-icon">ğŸŒ±</view>
    <view class="empty-text">{{i18n.emptyState.title}}</view>
    <view class="empty-tip">{{i18n.emptyState.tip}}</view>
  </view>

  <!-- æœ‹å‹åˆ†äº«ç§»è‡³ç‹¬ç«‹é¡µé¢ -->

  <!-- ç»¿æ¤åˆ—è¡¨ -->
  <view class="plant-list {{plantList.length === 1 ? 'single-plant' : (plantList.length === 2 ? 'two-plants' : 'multiple-plants')}} {{reorderMode ? 'reorder' : ''}}">
    
    <!-- æ‰¹é‡æ¨¡å¼æç¤ºï¼ˆå›ºå®šåœ¨é¡¶éƒ¨ï¼‰ -->
    <view wx:if="{{batchMode}}" class="batch-mode-tip">
      <text class="batch-tip-text">{{i18n.batchMode.tip}}</text>
      <text class="batch-tip-count">{{batchSelectionText}}</text>
    </view>
    <!-- å ä½ç¬¦ï¼Œé¿å…åˆ—è¡¨è¢«é¡¶éƒ¨æç¤ºé®æŒ¡ -->
    <view wx:if="{{batchMode}}" class="batch-mode-tip-spacer"></view>
    <!-- æ™®é€šæ¨¡å¼ -->
    <block wx:if="{{!reorderMode}}">
      <view class="plant-card {{batchMode ? 'batch-mode' : ''}} {{item.selected ? 'selected' : ''}}" 
            wx:for="{{plantList}}" wx:key="id" 
            data-id="{{item.id}}" data-index="{{index}}"
            bindtap="onCardTap" bindlongpress="enterReorderMode">
        <view wx:if="{{batchMode}}" class="batch-checkbox {{item.selected ? 'checked' : ''}}">
          <text class="checkbox-icon">{{item.selected ? 'âœ“' : ''}}</text>
        </view>
        <image class="card-image" src="{{item.images[0]}}" mode="aspectFill"></image>
        <view class="card-content">
          <view class="card-title">{{item.aiResult.name || i18nCommon.unknownPlant}}</view>
          <view class="card-info">
            <view class="info-item" wx:if="{{item.lastWateringDate}}">
              <text class="info-icon">ğŸ’§</text>
              <text>{{item.lastWateringDate}}</text>
            </view>
            <view class="info-item" wx:if="{{item.lastFertilizingDate && !item.lastWateringDate}}">
              <text class="info-icon">ğŸŒ±</text>
              <text>{{item.lastFertilizingDate}}</text>
            </view>
            <view class="info-item" wx:if="{{!item.lastWateringDate && !item.lastFertilizingDate}}">
              <text class="info-icon">ğŸ“…</text>
              <text>{{item.createDate}}</text>
            </view>
          </view>
        </view>
      </view>
    </block>

    <!-- æ’åºæ¨¡å¼ï¼šæ‹–æ‹½åˆ—è¡¨ -->
    <block wx:else>
      <movable-area class="reorder-area" style="width: 100%; height: {{reorderAreaHeight}}px;">
        <movable-view wx:for="{{plantList}}" wx:key="id"
                      class="reorder-item"
                      data-index="{{index}}"
                      x="0" y="{{index == draggingIndex ? dragY : (itemPositions[index] || basePositions[index] || 0)}}"
                      style="width: 100%; height: {{itemHeights[index] || fallbackItemHeightPx}}px;"
                      direction="vertical" inertia="true" out-of-bounds="true"
                      damping="40" friction="8"
                      bindchange="onDragChange"
                      bindtouchstart="onDragTouchStart" bindtouchend="onDragTouchEnd">
          <view class="plant-card reorder-card">
            <image class="card-image" src="{{item.images[0]}}" mode="aspectFill"></image>
            <view class="card-content">
              <view class="card-title">{{item.aiResult.name || i18nCommon.unknownPlant}}</view>
              <view class="card-info">
                <view class="info-item" wx:if="{{item.lastWateringDate}}">
                  <text class="info-icon">ğŸ’§</text>
                  <text>{{item.lastWateringDate}}</text>
                </view>
                <view class="info-item" wx:if="{{item.lastFertilizingDate && !item.lastWateringDate}}">
                  <text class="info-icon">ğŸŒ±</text>
                  <text>{{item.lastFertilizingDate}}</text>
                </view>
                <view class="info-item" wx:if="{{!item.lastWateringDate && !item.lastFertilizingDate}}">
                  <text class="info-icon">ğŸ“…</text>
                  <text>{{item.createDate}}</text>
                </view>
              </view>
            </view>
          </view>
        </movable-view>
      </movable-area>
    </block>
  </view>


  <!-- è®¾ç½®æŒ‰é’® -->
  <!-- é¡¶éƒ¨æ“ä½œåŒºï¼šè®¾ç½® + æœ‹å‹åˆ†äº«ï¼ˆç´§æŒ¨ç€ï¼‰ -->
  <view class="top-actions" wx:if="{{!batchMode}}">
    <view class="settings-button" bindtap="goToSettings">
      <text class="settings-icon">âš™ï¸</text>
    </view>
    <view class="friends-button" bindtap="goToFriends" wx:if="{{friendShares.length > 0}}">
      <text class="friends-icon">ğŸ‘¥</text>
    </view>
  </view>
  
  
  <!-- æ‰¹é‡æ“ä½œæŒ‰é’®ç»„ -->
  <view wx:if="{{batchMode}}" class="batch-actions">
    <view class="batch-action-btn" bindtap="batchWatering">
      <text class="batch-action-icon">ğŸ’§</text>
      <text class="batch-action-text">{{i18n.batchMode.watering}}</text>
    </view>
    <view class="batch-action-btn" bindtap="batchFertilizing">
      <text class="batch-action-icon">ğŸŒ±</text>
      <text class="batch-action-text">{{i18n.batchMode.fertilizing}}</text>
    </view>
    <view class="batch-action-btn cancel" bindtap="exitBatchMode">
      <text class="batch-action-icon">âœ•</text>
      <text class="batch-action-text">{{i18n.batchMode.exit}}</text>
    </view>
  </view>
  
  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions" wx:if="{{!batchMode}}">
    <!-- å·¦ä¾§æŒ‰é’®ç»„ -->
    <view class="left-buttons">
      <!-- æ‰¹é‡æµ‡æ°´æŒ‰é’® -->
      <view class="batch-watering-button" bindtap="batchWatering">
        <text class="batch-watering-icon">ğŸ’§</text>
      </view>
      
      <!-- æ‰¹é‡å†å²è®°å½•æŒ‰é’® -->
      <view class="batch-history-button" bindtap="viewBatchHistory">
        <text class="batch-history-icon">ğŸ“Š</text>
      </view>
      
      <!-- æé†’çŠ¶æ€æ  -->
      <view wx:if="{{reminderStatus && reminderStatus !== 'noPlants'}}" 
            class="reminder-status {{reminderStatus === 'needsWatering' ? 'needs-watering' : 'watered-recently'}} {{reminderStatus === 'needsWatering' ? 'clickable' : ''}}"
            bindtap="{{reminderStatus === 'needsWatering' ? 'showNeedsWateringPlants' : ''}}">
        <text class="reminder-icon">{{reminderStatus === 'needsWatering' ? 'ğŸ’§' : 'âœ…'}}</text>
        <text class="reminder-text">{{reminderText}}</text>
        <text wx:if="{{reminderStatus === 'needsWatering'}}" class="reminder-hint">ğŸ‘†</text>
      </view>
    </view>
    
    <!-- å³ä¾§æ·»åŠ æŒ‰é’® -->
    <view class="add-plant-button" bindtap="goToAdd">
      <text class="add-icon">+</text>
    </view>
  </view>

  <!-- æ’åºæ¨¡å¼åº•éƒ¨æ“ä½œæ  -->
  <view class="reorder-actions" wx:if="{{reorderMode}}" catchtap="noop">
    <view class="reorder-tip">é•¿æŒ‰è¿›å…¥æ’åºï¼Œæ‹–æ‹½è°ƒæ•´é¡ºåº</view>
    <view class="reorder-finish" bindtap="finishReorder">å®Œæˆ</view>
  </view>
  
  <!-- æ‰¹é‡æ“ä½œå†å²å¼¹çª— -->
  <view class="batch-history-modal" wx:if="{{showBatchHistoryModal}}" bindtap="closeBatchHistoryModal">
    <view class="batch-history-content" catchtap="stopPropagation">
      <view class="batch-history-header">
        <text class="batch-history-title">{{i18n.batchMode.historyTitle}}</text>
        <text class="close-btn" bindtap="closeBatchHistoryModal">âœ•</text>
      </view>
      <scroll-view class="batch-history-list" scroll-y="true">
        <view class="batch-history-item" wx:for="{{batchHistoryData}}" wx:key="timestamp">
          <view class="batch-history-info">
            <view class="batch-history-type">{{item.typeText}}</view>
            <view class="batch-history-time">{{item.date}} {{item.time}}</view>
          </view>
          <view class="batch-history-plants">
            <text class="batch-history-count">{{item.plantCountLabel}}</text>
            <text class="batch-history-plant-list">{{item.plantList}}</text>
          </view>
        </view>
        <view class="batch-history-empty" wx:if="{{batchHistoryData.length === 0}}">
          <text class="empty-icon">ğŸ“‹</text>
          <text class="empty-text">{{i18n.batchMode.emptyHistory}}</text>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
